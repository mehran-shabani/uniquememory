# ماتریس Scope و حساسیت (MVP)

هدف این ماتریس تعریف حداقل سیاست‌های دسترسی است تا MVP بتواند نیازهای CRUD، جست‌وجو و رضایت را پوشش دهد. تمام سیاست‌ها در Django و لایهٔ API اعمال می‌شوند و در کش محلی بازتاب دارند.

## تعاریف Scope
* `memory.read`: خواندن ورودی‌های حافظه.
* `memory.write`: ایجاد/به‌روزرسانی/حذف ورودی.
* `memory.search`: جست‌وجوی هیبریدی با خروجی snippet.
* `consent.read`: مشاهدهٔ رضایت‌های فعال.
* `consent.manage`: ایجاد/لغو رضایت.
* `audit.read`: خواندن گزارش ممیزی.

## ماتریس دسترسی بر اساس حساسیت
| Scope \ حساسیت | Low | Medium | High | Critical |
| --- | --- | --- | --- | --- |
| `memory.read` | مجاز با رضایت فعال | مجاز با رضایت و سطح حساسیت ≥ Medium | نیازمند نقش تخصصی + رضایت با حساسیت High | فقط برای موقعیت اضطراری؛ نیاز به token موقت و Alert |
| `memory.write` | مجاز برای ایجنت‌های ثبت‌شده | مجاز با سیاست نگهداری مشخص و ممیزی | نیازمند تایید ثانویه (policy engine) | فقط توسط ایجنت کاربر یا پرتال؛ ذخیره در مسیر ایزوله |
| `memory.search` | نتایج کامل | نتایج بدون فیلدهای حساس اضافی | فقط snippetهای mask شده | ممنوع؛ جست‌وجو باید با `memory.read` درخواست نقطه‌ای جایگزین شود |
| `consent.read` | قابل مشاهده برای کاربر و ایجنت خود | مشابه Low | فقط کاربر و تیم حقوقی | فقط کاربر؛ اطلاع‌رسانی SMS هنگام مشاهده |
| `consent.manage` | کاربر یا ایجنت نیابتی تأییدشده | فقط کاربر یا پرتال رسمی | فقط کاربر + تایید OTP | فقط کاربر با OTP دو مرحله‌ای |
| `audit.read` | گزارش خلاصه | گزارش کامل برای کاربر | برای ایجنت محدود به رکوردهای خود | فقط تیم امنیتی با مجوز مخصوص |

## هم‌راستاسازی با MVP
* **CRUD**: با ترکیب `memory.write` و `memory.read` برای Low/Medium قادر به پوشش اکثر سناریوها هستیم؛ High/Critical با مسیرهای محدودتر ولی همچنان موجود.
* **جست‌وجوی هیبریدی**: `memory.search` برای Low/Medium فعال است تا قابلیت RAG MVP تضمین شود؛ برای High خروجی ماسک‌شده ارائه می‌شود تا ریسک کاهش یابد.
* **رضایت قابل بازپس‌گیری**: `consent.manage` برای تمام سطوح به کاربر سپرده شده و راهکار OTP به محافظت Critical کمک می‌کند.
* **ممیزی کامل**: `audit.read` برای کاربر همیشه مجاز است اما برای ایجنت‌ها محدود می‌شود تا دادهٔ سایر شرکت‌ها افشا نشود.

## قوانین تکمیلی
1. هر درخواست باید ترکیب `scope` و `consent.sensitivity_levels` را پاس کند؛ نتیجه مجموعهٔ اشتراک است.
2. برای سطوح High/Critical، لاگ ممیزی در زمان واقعی به سیستم هشدار ارسال می‌شود.
3. پس از revoke، تمام cache entries مرتبط با user+scope در کمتر از ۳۰ ثانیه منقضی می‌شوند.
4. در MVP توکن‌های Critical فقط توسط پرتال کاربر صادر و پس از استفاده تک‌بار هستند.

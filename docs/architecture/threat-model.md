# مدل تهدید MVP

## دارایی‌های حیاتی
* **داده‌های حافظهٔ کاربر** (متن آزاد، ساختار‌یافته، پیوست‌ها).
* **Artifacts رضایت** شامل محدودهٔ دسترسی و سطح حساسیت.
* **توکن‌های دسترسی** برای ایجنت‌ها و کاربران.
* **شاخص‌های ممیزی** و لاگ‌های امنیتی.

## مهاجمان محتمل
* ایجنت یا شرکت مخرب که به دنبال گسترش دسترسی فراتر از رضایت است.
* مهاجم خارجی با هدف سرقت دادهٔ حساس از API یا پایگاه‌داده.
* کاربر داخلی (ادمین) که از اختیارات خود سوءاستفاده می‌کند.
* بدافزار روی کلاینت کاربر که توکن را سرقت می‌کند.

## سطح حمله و بردارها
| لایه | تهدید | کنترل پیشنهادی |
| --- | --- | --- |
| احراز هویت | سرقت توکن API | انقضای کوتاه، چرخش کلیدها، DPoP/PKCE برای کاربر، mTLS اختیاری شرکت‌ها |
| API Gateway | حملات Brute-force و Rate limit bypass | Rate limiting بر اساس client_id و کاربر، قفل موقت، هشدار امنیت |
| Memory Core (Django) | تزریق SQL/NoSQL و دسترسی بدون رضایت | ORM + فیلتر Scope/ABAC در لایهٔ سرویس، تست نفوذ، قاعدهٔ deny-by-default |
| ذخیره‌سازی | سرقت فایل پیوست یا DB snapshot | رمزگذاری at-rest، مدیریت کلید داخلی، تفکیک شبکه، مانیتورینگ دسترسی |
| کش محلی | دادهٔ stale پس از لغو رضایت | TTL کوتاه، Propagation رویداد revoke، پاک‌سازی فوری Celery |
| MCP Server | تزریق درخواست یا دزدیدن پاسخ | امضای درخواست، محدودسازی IP شرکت‌ها، Sanitization پاسخ |
| فرایند توسعه | ضعف در مدیریت اسرار | استفاده از فایل env رمزگذاری‌شده، کنترل دسترسی Git، بررسی کد |

## سناریوهای تهدید اولویت‌دار
1. **ارتقای سطح حساسیت بدون رضایت:** مهاجم تلاش می‌کند با تغییر پارامتر درخواست، دادهٔ با سطح high را بخواند. *کنترل:* بررسی تقاطع consent.sensitivity_levels و درخواست، تست واحد اجباری.
2. **استفاده از توکن منقضی‌شده:** کش محلی توکن را نگه می‌دارد و پس از revoke هنوز اجازهٔ دسترسی می‌دهد. *کنترل:* Sync رویداد revoke به cache و enforce در لایهٔ میانی.
3. **تزریق دادهٔ مخرب در فایل‌سیستم:** آپلود پیوست حاوی اسکریپت. *کنترل:* اسکن نوع MIME، ذخیره در مسیر ایزوله، امضای لینک دانلود.
4. **دسترسی غیرمجاز ادمین:** ادمین داخلی ممیزی را حذف می‌کند. *کنترل:* تفکیک نقش، Immutable audit log (append-only)، بازبینی دوره‌ای.
5. **افشای داده در حین انتقال:** حملهٔ MITM. *کنترل:* TLS1.3 اجباری، HSTS، پایش گواهی.

## ماتریس احتمال/تاثیر
| تهدید | احتمال | تاثیر | اولویت |
| --- | --- | --- | --- |
| سرقت توکن API | متوسط | بالا | بحرانی |
| تزریق SQL | پایین | بالا | بالا |
| کش invalidate نشده | متوسط | متوسط | بالا |
| افشای فایل پیوست | پایین | بسیار بالا | بحرانی |
| دستکاری ممیزی | بسیار پایین | بالا | متوسط |

## فعالیت‌های امنیتی MVP
* پیاده‌سازی تست‌های خودکار برای مسیرهای CRUD و Consent.
* راه‌اندازی SAST/Dependency check در CI.
* اجرای tabletop برای سناریوی revoke و اطلاع‌رسانی کاربر.
* تعریف Runbook واکنش به رخداد امنیتی.
